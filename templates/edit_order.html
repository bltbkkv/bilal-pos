{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Ññ{{ order.id }}</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <style>
    body { font-family: sans-serif; background: #f5f5f5; color: #222; margin: 0; }
    .topbar { background: #222; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 20px; }
    .topbar .nav a { color: white; margin-left: 20px; text-decoration: none; font-size: 20px; }
    .wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
    .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .panel h3 { margin-top: 0; font-size: 22px; }
    .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 20px; }
    .btn { cursor: pointer; border: none; padding: 16px 24px; border-radius: 10px; font-size: 20px; }
    .btn-green { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-primary { background: #007bff; color: white; }
    .btn-small { padding: 8px 12px; font-size: 16px; }
    .total { font-weight: bold; font-size: 22px; margin-top: 12px; }
    .tabs { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
    .tab-btn { background: #eee; border: none; padding: 16px 24px; border-radius: 10px; cursor: pointer; font-size: 18px; }
    .tab-btn:hover { background: #ddd; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .product-card { border: 2px solid #ddd; border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; background: #fafafa; font-size: 18px; }
    .notify {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }
    .notify.show { opacity: 1; }
    .notify.error { background: #dc3545; }
/* –ú–æ–¥–∞–ª–∫–∞ –æ–ø–ª–∞—Ç—ã */
#payment-modal .modal-content {
  background: #111;
  width: 320px;
  border-radius: 8px;
  padding: 20px;
  color: #fff;
  text-align: center;
}

#payment-modal h2 {
  margin-bottom: 12px;
  font-size: 20px;
}

#payment-modal p {
  margin: 8px 0;
  font-size: 16px;
}

#payment-display {
  width: 100%;
  font-size: 28px;
  padding: 10px;
  margin-bottom: 15px;
  text-align: center;
  border: none;
  border-radius: 8px;
  background: #222;
  color: #fff;
}

#payment-change {
  font-size: 20px;
  font-weight: bold;
  margin-top: 8px;
}

/* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã */
#payment-modal .keyboard {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 10px;
}

#payment-modal .keyboard button {
  font-size: 24px;
  padding: 20px;
  background: #333;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

#payment-modal .keyboard button:hover {
  background: #555;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
#payment-modal .actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

#payment-modal .actions button {
  flex: 1;
  padding: 18px 24px;   /* —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
  font-size: 20px;      /* –∫—Ä—É–ø–Ω–µ–µ —Ç–µ–∫—Å—Ç */
  border-radius: 10px;  /* –±–æ–ª–µ–µ –æ–∫—Ä—É–≥–ª—ã–µ —É–≥–ª—ã */
  border: none;
  cursor: pointer;
}

#btn-paid {
  background: #0a0;
  color: #fff;
  font-weight: bold;
}

#btn-cancel-payment {
  background: #a00;
  color: #fff;
  font-weight: bold;
}


  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="actions" style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
      <button class="btn btn-primary" onclick="reprintReceipt({{ order.id }})">üñ®Ô∏è –ß–µ–∫</button>
      <button class="btn btn-primary" onclick="callOrder({{ order.id }})">üì¢ –í—ã–∑–æ–≤</button>
      <button class="btn btn-secondary" onclick="goBack()">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <h3>–ó–∞–∫–∞–∑ ‚Ññ{{ order.receipt_number }}</h3>
      <div id="order-items">
        {% for it in items %}
          <div class="item-row">
            <div>{{ it.product.name }} √ó {{ it.quantity }} ‚Äî {{ it.line_total }} —Å–æ–º</div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-small btn-primary" onclick="decreaseItemQuantity({{ it.id }}, {{ it.quantity }})">‚àí</button>
              <button class="btn btn-small btn-danger" onclick="removeItem({{ it.id }})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="total">–ò—Ç–æ–≥–æ: <span id="order-total">{{ order.total }} —Å–æ–º</span></div>

      <!-- –ù–∞–∑–∞–¥ (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π) -->

      <!-- –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å -->
      <button class="btn btn-primary" onclick="recalc({{ order.id }})">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>

      <!-- –ü–æ–¥ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ–º –û—Ç–º–µ–Ω–∏—Ç—å –∏ –ì–æ—Ç–æ–≤–æ -->
      <div style="margin-top:10px; display:flex; gap:24px; flex-wrap:wrap;">
        <button class="btn btn-green" onclick="openPaymentModal({{ order.id }}, {{ order.total }})">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
        <button class="btn btn-danger" onclick="cancelOrder({{ order.id }})">‚ùå –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>

    <div class="panel">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–∞</h3>
      <div class="tabs">
        {% for cat in categories %}
          <button class="tab-btn" onclick="showTab('{{ cat }}')">{{ cat }}</button>
        {% endfor %}
      </div>

      {% for cat in categories %}
        <div class="tab-content" id="tab-{{ cat }}" style="display: none;">
          <div class="grid">
            {% for p in products %}
              {% if p.category == cat %}
                <div class="product-card">
                  <div>{{ p.name }} ‚Äî {{ p.price }} —Å–æ–º</div>
                  <button class="btn btn-green" onclick="addItem({{ order.id }}, {{ p.id }})">+</button>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div id="notify" class="notify"></div>

  <script>
    // CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // –ù–∞–∑–∞–¥ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   async function goBack() {
  const orderId = {{ order.id }};  // Django –≤—Å—Ç–∞–≤–∏—Ç ID –∑–∞–∫–∞–∑–∞

  try {
    await fetch(`/orders/${orderId}/discard-draft/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken
      }
    });
  } catch (e) {
    console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤", e);
  }

  window.location.href = "/orders/";
}


    function showTab(cat) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      const target = document.getElementById('tab-' + cat);
      if (target) target.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const firstTab = document.querySelector('.tab-content');
      if (firstTab) firstTab.style.display = 'block';
    });

    async function addItem(orderId, productId) {
      const resp = await fetch(`/orders/${orderId}/add-item/`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({product_id: productId, qty: 1})
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'); return; }
      redrawItems(data.items, data.total);
    }

    async function removeItem(itemId) {
      const resp = await fetch(`/order-items/${itemId}/remove/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); return; }
      redrawItems(data.items, data.total);
    }

    async function decreaseItemQuantity(itemId, currentQty) {
      const newQty = currentQty - 1;
      const resp = await fetch(`/order-items/${itemId}/reduce/`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: `quantity=${newQty}`
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || '–û—à–∏–±–∫–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è'); return; }
      redrawItems(data.items, data.total);
    }

    // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å: –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–∫–∞–∑, –Ω–∞–ø–µ—á–∞—Ç–∞—Ç—å —á–µ–∫–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å –≤–æ –≤–∫–ª–∞–¥–∫—É "–ó–∞–∫–∞–∑—ã"
    async function recalc(orderId) {
      try {
        const resp = await fetch(`/orders/${orderId}/recalc/`, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken}
        });
        const data = await resp.json();

        if (!data.ok) {
          notify('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞', 'error');
          setTimeout(() => { window.location.href = "/orders/"; }, 800);
          return;
        }

        if (data.items && data.total !== undefined) {
          redrawItems(data.items, data.total);
        }

        if (data.recalc) {
          notify('üñ®Ô∏è –ß–µ–∫ —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!');
        } else {
          notify('–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç');
        }

        setTimeout(() => {
          window.location.href = "/orders/";
        }, 900);

      } catch (e) {
        notify('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ', 'error');
        setTimeout(() => { window.location.href = "/orders/"; }, 900);
      }
    }

    function redrawItems(items, total) {
      const list = document.getElementById('order-items');
      list.innerHTML = '';
      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <div>${it.name} √ó ${it.quantity} ‚Äî ${it.line_total} —Å–æ–º</div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-small btn-primary" onclick="decreaseItemQuantity(${it.id}, ${it.quantity})">‚àí</button>
            <button class="btn btn-small btn-danger" onclick="removeItem(${it.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        list.appendChild(row);
      });
      document.getElementById('order-total').innerText = total + ' —Å–æ–º';
    }

    async function markReady(orderId) {
      const resp = await fetch(`/orders/${orderId}/ready/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });
      const data = await resp.json();
      if (data.ok) window.location.href = "/orders/";
      else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞");
    }

    async function cancelOrder(orderId) {
      const resp = await fetch(`/orders/${orderId}/cancel/`);
      const data = await resp.json();
      if (data.ok) window.location.href = "/orders/";
      else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞");
    }

    function reprintReceipt(orderId) {
      fetch(`/orders/${orderId}/receipt/reprint/`)
        .then(r => r.json())
        .then(data => {
          if (data.ok) notify("üñ®Ô∏è –ß–µ–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!");
          else notify("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ —á–µ–∫–∞", "error");
        })
        .catch(() => notify("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏", "error"));
    }

    function callOrder(orderId) {
      fetch(`/orders/${orderId}/call/`)
        .then(r => r.json())
        .then(data => { if (data.ok) console.log("–í—ã–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω"); })
        .catch(() => console.log("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ –∑–∞–∫–∞–∑–∞"));
    }

    function notify(msg, type="success") {
      const box = document.getElementById('notify');
      if (!box) return;
      box.textContent = msg;
      box.className = "notify " + (type === "error" ? "error show" : "show");
      setTimeout(() => {
        box.className = "notify";
      }, 2000);
    }

    // ====== –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–∫–∏ –æ–ø–ª–∞—Ç—ã ======
    let currentOrderId = null;
    let currentOrderTotal = 0;

    function openPaymentModal(orderId, total) {
      currentOrderId = orderId;
      currentOrderTotal = total;
      document.getElementById('payment-total').textContent = total;
      document.getElementById('payment-display').value = "";
      document.getElementById('payment-change').textContent = "0";
      document.getElementById('payment-modal').style.display = "flex";
    }

    function closePaymentModal() {
      document.getElementById('payment-modal').style.display = "none";
    }

    function pressPayKey(val) {
      const display = document.getElementById("payment-display");
      display.value += val;
      updatePaymentChange();
    }

    function clearPayInput() {
      const display = document.getElementById("payment-display");
      display.value = "";
      updatePaymentChange();
    }

    function backspacePay() {
      const display = document.getElementById("payment-display");
      display.value = display.value.slice(0, -1);
      updatePaymentChange();
    }

    function updatePaymentChange() {
      const display = document.getElementById("payment-display");
      const changeSpan = document.getElementById("payment-change");
      const cash = parseFloat(display.value) || 0;
      const change = cash - currentOrderTotal;
      changeSpan.textContent = change.toFixed(2);
      changeSpan.style.color = change >= 0 ? "green" : "red";
    }

    async function confirmPayment() {
      if (!currentOrderId) return;
      const resp = await fetch(`/orders/${currentOrderId}/ready/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });
      const data = await resp.json();
      if (data.ok) {
        closePaymentModal();
        window.location.href = "/orders/";
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞");
      }
    }
</script>

</body>

<div id="payment-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h2>–û–ø–ª–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</h2>
    <p>–ò—Ç–æ–≥–æ: <span id="payment-total">0</span> —Å–æ–º</p>

    <input id="payment-display" type="text" readonly placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />
    <p>–°–¥–∞—á–∞: <span id="payment-change">0</span> —Å–æ–º</p>

    <div class="keyboard">
      <button onclick="pressPayKey('1')">1</button>
      <button onclick="pressPayKey('2')">2</button>
      <button onclick="pressPayKey('3')">3</button>
      <button onclick="pressPayKey('4')">4</button>
      <button onclick="pressPayKey('5')">5</button>
      <button onclick="pressPayKey('6')">6</button>
      <button onclick="pressPayKey('7')">7</button>
      <button onclick="pressPayKey('8')">8</button>
      <button onclick="pressPayKey('9')">9</button>
      <button onclick="pressPayKey('0')">0</button>
      <button onclick="clearPayInput()">C</button>
      <button onclick="backspacePay()">‚Üê</button>
    </div>

    <div class="actions" style="margin-top:20px; display:flex; gap:16px;">
      <button id="btn-paid" onclick="confirmPayment()">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
      <button id="btn-cancel-payment" onclick="closePaymentModal()">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

  </div>
</div>




</html>



