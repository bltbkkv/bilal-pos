{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Ññ{{ order.id }}</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <style>
    body { font-family: sans-serif; background: #f5f5f5; color: #222; margin: 0; }
    .topbar { background: #222; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; font-size: 20px; }
    .topbar .nav a { color: white; margin-left: 20px; text-decoration: none; font-size: 20px; }
    .wrap { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
    .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .panel h3 { margin-top: 0; font-size: 22px; }
    .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 20px; }
    .btn { cursor: pointer; border: none; padding: 16px 24px; border-radius: 10px; font-size: 20px; }
    .btn-green { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-primary { background: #007bff; color: white; }
    .btn-small { padding: 8px 12px; font-size: 16px; }
    .total { font-weight: bold; font-size: 22px; margin-top: 12px; }
    .tabs { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
    .tab-btn { background: #eee; border: none; padding: 16px 24px; border-radius: 10px; cursor: pointer; font-size: 18px; }
    .tab-btn:hover { background: #ddd; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
    .product-card { border: 2px solid #ddd; border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; background: #fafafa; font-size: 18px; }
    .notify {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #28a745;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 16px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 9999;
}
.notify.show { opacity: 1; }
.notify.error { background: #dc3545; }

  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="actions" style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
      <button class="btn btn-primary" onclick="reprintReceipt({{ order.id }})">üñ®Ô∏è –ß–µ–∫</button>
      <button class="btn btn-primary" onclick="callOrder({{ order.id }})">üì¢ –í—ã–∑–æ–≤</button>
      <button class="btn btn-danger" onclick="cancelOrder({{ order.id }})">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
      <button class="btn btn-green" onclick="markReady({{ order.id }})">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <h3>–ó–∞–∫–∞–∑ ‚Ññ{{ order.receipt_number }}</h3>
      <div id="order-items">
        {% for it in items %}
          <div class="item-row">
            <div>{{ it.product.name }} √ó {{ it.quantity }} ‚Äî {{ it.line_total }} —Å–æ–º</div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-small btn-primary" onclick="decreaseItemQuantity({{ it.id }}, {{ it.quantity }})">‚àí</button>
              <button class="btn btn-small btn-danger" onclick="removeItem({{ it.id }})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <div class="total">–ò—Ç–æ–≥–æ: <span id="order-total">{{ order.total }} —Å–æ–º</span></div>
      <button class="btn btn-primary" onclick="recalc({{ order.id }})">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
    </div>

    <div class="panel">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–∞</h3>
      <div class="tabs">
        {% for cat in categories %}
          <button class="tab-btn" onclick="showTab('{{ cat }}')">{{ cat }}</button>
        {% endfor %}
      </div>

      {% for cat in categories %}
        <div class="tab-content" id="tab-{{ cat }}" style="display: none;">
          <div class="grid">
            {% for p in products %}
              {% if p.category == cat %}
                <div class="product-card">
                  <div>{{ p.name }} ‚Äî {{ p.price }} —Å–æ–º</div>
                  <button class="btn btn-green" onclick="addItem({{ order.id }}, {{ p.id }})">+</button>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
<div id="notify" class="notify"></div>

  <script>
    // CSRF —Ç–æ–∫–µ–Ω –∏–∑ cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showTab(cat) {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.getElementById('tab-' + cat).style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const firstTab = document.querySelector('.tab-content');
      if (firstTab) firstTab.style.display = 'block';
    });

    async function addItem(orderId, productId) {
      const resp = await fetch(`/orders/${orderId}/add-item/`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({product_id: productId, qty: 1})
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è'); return; }
      redrawItems(data.items, data.total);
    }

    async function removeItem(itemId) {
      const resp = await fetch(`/order-items/${itemId}/remove/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); return; }
      redrawItems(data.items, data.total);
    }

    async function decreaseItemQuantity(itemId, currentQty) {
      const newQty = currentQty - 1;
      const resp = await fetch(`/order-items/${itemId}/reduce/`, {
        method: 'POST',
        headers: {
          'Content-Type':'application/x-www-form-urlencoded',
          'X-CSRFToken': csrftoken
        },
        body: `quantity=${newQty}`
      });
      const data = await resp.json();
      if (!data.ok) { alert(data.error || '–û—à–∏–±–∫–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è'); return; }
      redrawItems(data.items, data.total);
    }

    async function recalc(orderId) {
      const resp = await fetch(`/orders/${orderId}/recalc/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
      });
      const data = await resp.json();
      if (!data.ok) {
        alert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞');
        return;
      }
      redrawItems(data.items, data.total);
      window.location.href = "/orders/";
    }

    function redrawItems(items, total) {
      const list = document.getElementById('order-items');
      list.innerHTML = '';
      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <div>${it.name} √ó ${it.quantity} ‚Äî ${it.line_total} —Å–æ–º</div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-small btn-primary" onclick="decreaseItemQuantity(${it.id}, ${it.quantity})">‚àí</button>
            <button class="btn btn-small btn-danger" onclick="removeItem(${it.id})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        list.appendChild(row);
      });
      document.getElementById('order-total').innerText = total + ' —Å–æ–º';
    }


  async function markReady(orderId) {
    const resp = await fetch(`/orders/${orderId}/ready/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    });
    const data = await resp.json();
    if (data.ok) window.location.href = "/orders/";
    else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞");
  }



    async function cancelOrder(orderId) {
      const resp = await fetch(`/orders/${orderId}/cancel/`);
      const data = await resp.json();
      if (data.ok) window.location.href = "/orders/";
      else alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞");
    }

    function reprintReceipt(orderId) {
  fetch(`/orders/${orderId}/receipt/reprint/`)
    .then(r => r.json())
    .then(data => {
      if (data.ok) notify("üñ®Ô∏è –ß–µ–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!");
      else notify("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ —á–µ–∫–∞", "error");
    });
}



    function callOrder(orderId) {
      fetch(`/orders/${orderId}/call/`)
        .then(r => r.json())
        .then(data => { if (data.ok) console.log("–í—ã–∑–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω"); });
    }
    function notify(msg, type="success") {
  const box = document.getElementById('notify');
  if (!box) return;
  box.textContent = msg;
  box.className = "notify " + (type === "error" ? "error show" : "show");
  setTimeout(() => {
    box.className = "notify"; // —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫
  }, 2000);
}

  </script>
</body>
</html>
