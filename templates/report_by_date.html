{% load custom_filters %}
{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û—Ç—á—ë—Ç –ø–æ –¥–∞—Ç–µ</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
    }
    .topbar {
      background: #222;
      color: white;
      padding: 14px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .topbar .brand {
      font-size: 20px;
      font-weight: bold;
    }
    .topbar .nav a {
      color: white;
      margin-left: 20px;
      font-weight: bold;
      text-decoration: none;
    }
    .topbar .nav a:hover {
      color: #ffc107;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      padding: 30px;
    }
    h2 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #fff;
    }

    .filter-box {
      background: #2c2c2c;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .filter-box label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #ccc;
    }
    .filter-box input {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1a1a1a;
      color: #f0f0f0;
    }
    .filter-box button {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
    }

    .summary {
      margin-bottom: 20px;
      font-size: 16px;
      color: #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #2a2a2a;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #444;
      text-align: left;
    }
    th {
      background: #333;
      color: #ffc107;
    }
    td {
      color: #f0f0f0;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="nav">
      <a href="/menu/">–ú–µ–Ω—é</a>
      <a href="{% url 'orders_list' %}">–ó–∞–∫–∞–∑—ã</a>
    </div>
  </header>

  <div class="container">
    <h2>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ –∏ –≤—Ä–µ–º–µ–Ω–∏</h2>
    <form method="post" class="filter-box">
      {% csrf_token %}
      {% if login_required %}
        <label>–ü–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞:</label>
        <input type="password" name="password" required>
        {% if login_error %}
          <p style="color:#ff4d4d;">{{ login_error }}</p>
        {% endif %}
      {% else %}
        <label>–ù–∞—á–∞–ª–æ –¥–∞—Ç—ã:</label>
        <input type="date" name="start" value="{{ start_date }}">
        <label>–ö–æ–Ω–µ—Ü –¥–∞—Ç—ã:</label>
        <input type="date" name="end" value="{{ end_date }}">
        <label>–ù–∞—á–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏:</label>
        <input type="time" name="start_time" value="{{ start_time }}">
        <label>–ö–æ–Ω–µ—Ü –≤—Ä–µ–º–µ–Ω–∏:</label>
        <input type="time" name="end_time" value="{{ end_time }}">
        <button type="submit">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
      {% endif %}
    </form>

    {% if not login_required %}
      <div class="summary">
        <p>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤: <strong>{{ count }}</strong></p>
        <p>–û–±—â–∞—è —Å—É–º–º–∞: <strong>{{ total }} —Å–æ–º</strong></p>
        <!-- üîπ –¥–æ–±–∞–≤–ª–µ–Ω–æ -->
        <p>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å: <strong>{{ profit }} —Å–æ–º</strong></p>
      </div>

      <form method="get" action="{% url 'report_receipt' %}">
        <input type="hidden" name="start" value="{{ start_date }}">
        <input type="hidden" name="end" value="{{ end_date }}">
        <input type="hidden" name="start_time" value="{{ start_time }}">
        <input type="hidden" name="end_time" value="{{ end_time }}">
        <button type="submit">–í—ã–¥–∞—Ç—å —á–µ–∫</button>
      </form>
   {% load custom_filters %}

<table>
  <tr>
    <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
    <th>–ü—Ä–∏–≤–µ–∑–µ–Ω–æ</th>
    <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>
    <th>–û—Å—Ç–∞—Ç–æ–∫</th>
  </tr>

  <tr>
    <td>M-–ª–∞–≤–∞—à</td>
    <td><input type="number" name="delivered_lavash_m" value="{{ delivered_lavash_m|default:0 }}"></td>
    <td>
      {% if ingredients_usage %}
        <span>{{ ingredients_usage|get_item:"lavash_m" }}</span>
      {% else %}
        <span>0</span>
      {% endif %}
    </td>
    <td>
      {% if ingredients_usage %}
        <span>{{ delivered_lavash_m|default:0|add:"-"|add:ingredients_usage|get_item:"lavash_m"|default:"0" }}</span>
      {% else %}
        <span>{{ delivered_lavash_m|default:0 }}</span>
      {% endif %}
    </td>
  </tr>
  <tr>
    <td>–õ-–ª–∞–≤–∞—à</td>
    <td><input type="number" name="delivered_lavash_l" value="{{ delivered_lavash_l|default:0 }}"></td>
    <td>
      {% if ingredients_usage %}
        <span>{{ ingredients_usage|get_item:"lavash_l" }}</span>
      {% else %}
        <span>0</span>
      {% endif %}
    </td>
    <td>
      {% if ingredients_usage %}
        <span>{{ delivered_lavash_l|default:0|add:"-"|add:ingredients_usage|get_item:"lavash_l"|default:"0" }}</span>
      {% else %}
        <span>{{ delivered_lavash_l|default:0 }}</span>
      {% endif %}
    </td>
  </tr>
  <tr>
    <td>–°—ã—Ä–Ω—ã–π –ª–∞–≤–∞—à</td>
    <td><input type="number" name="delivered_lavash_s" value="{{ delivered_lavash_s|default:0 }}"></td>
    <td>
      {% if ingredients_usage %}
        <span>{{ ingredients_usage|get_item:"lavash_s" }}</span>
      {% else %}
        <span>0</span>
      {% endif %}
    </td>
    <td>
      {% if ingredients_usage %}
        <span>{{ delivered_lavash_s|default:0|add:"-"|add:ingredients_usage|get_item:"lavash_s"|default:"0" }}</span>
      {% else %}
        <span>{{ delivered_lavash_s|default:0 }}</span>
      {% endif %}
    </td>
  </tr>

  <tr>
  <td>–ë—É–ª–æ—á–∫–∞</td>
  <td><input type="number" name="delivered_bun" value="{{ delivered_bun|default:0 }}"></td>
  <td>
    {% if ingredients_usage %}
      <span>{{ ingredients_usage|get_item:"bun" }}</span>
    {% else %}
      <span>0</span>
    {% endif %}
  </td>
  <td>
    {% if ingredients_usage %}
      <span>{{ delivered_bun|default:0|add:"-"|add:ingredients_usage|get_item:"bun"|default:"0" }}</span>
    {% else %}
      <span>{{ delivered_bun|default:0 }}</span>
    {% endif %}
  </td>
</tr>

<tr>
  <td>–°—Ç—Ä–∏–ø—Å—ã (–∫–≥)</td>
  <td><input type="number" step="0.1" name="delivered_strips" value="{{ delivered_strips|default:0 }}"></td>
  <td>
    {% if ingredients_usage %}
      <span>{{ ingredients_usage|get_item:"strips" }}</span>
    {% else %}
      <span>0</span>
    {% endif %}
  </td>
  <td>
    {% if ingredients_usage %}
      <span>{{ delivered_strips|default:0|add:"-"|add:ingredients_usage|get_item:"strips"|default:"0" }}</span>
    {% else %}
      <span>{{ delivered_strips|default:0 }}</span>
    {% endif %}
  </td>
</tr>

<tr>
  <td>–ö—Ä—ã–ª—ã—à–∫–∏ (—à—Ç)</td>
  <td><input type="number" name="delivered_wings" value="{{ delivered_wings|default:0 }}"></td>
  <td>
    {% if ingredients_usage %}
      <span>{{ ingredients_usage|get_item:"wings" }}</span>
    {% else %}
      <span>0</span>
    {% endif %}
  </td>
  <td>
    {% if ingredients_usage %}
      <span>{{ delivered_wings|default:0|add:"-"|add:ingredients_usage|get_item:"wings"|default:"0" }}</span>
    {% else %}
      <span>{{ delivered_wings|default:0 }}</span>
    {% endif %}
  </td>
</tr>

  <!-- –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ –¥–ª—è –±—É–ª–æ—á–µ–∫, —Å—Ç—Ä–∏–ø—Å–æ–≤, –∫—Ä—ã–ª—ã—à–µ–∫ -->
</table>

<script>
  function recalc() {
    const delivered = {};
    const used = {};
    document.querySelectorAll('.delivered').forEach(inp => {
      const key = inp.dataset.key;
      delivered[key] = parseFloat(inp.value || 0);
    });
    document.querySelectorAll('.used').forEach(span => {
      const key = span.dataset.key;
      used[key] = parseFloat(span.textContent || 0);
    });
    document.querySelectorAll('.left').forEach(span => {
      const key = span.dataset.key;
      const left = (delivered[key] || 0) - (used[key] || 0);
      span.textContent = left.toFixed(2);
    });
  }

  document.querySelectorAll('.delivered').forEach(inp => {
    inp.addEventListener('input', recalc);
  });

  recalc();
</script>

      <!-- üîπ —Ç–∞–±–ª–∏—Ü–∞ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º -->
      <h2>–ü—Ä–∏–±—ã–ª—å –ø–æ —Ç–æ–≤–∞—Ä–∞–º</h2>
      <table>
        <tr>
          <th>–¢–æ–≤–∞—Ä</th>
          <th>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
          <th>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
          <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
          <th>–ü—Ä–∏–±—ã–ª—å</th>
        </tr>
        {% for item in items_profit %}
        <tr>
          <td>{{ item.product__name }}</td>
          <td>{{ item.product__price }}</td>
          <td>{{ item.product__cost_price }}</td>
          <td>{{ item.total_qty }}</td>
          <td>{{ item.total_profit }}</td>
        </tr>
        {% endfor %}
      </table>
    {% endif %}
  </div>
</body>
</html>

