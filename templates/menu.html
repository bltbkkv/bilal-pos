{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–∞—Å—Å–∞ ‚Äî –ú–µ–Ω—é</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <script defer src="{% static 'js/cart.js' %}"></script>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #1e1e1e;
  color: #f0f0f0;
  font-size: 16px;
  width: 1024px;
  height: 768px;
  overflow: hidden;
}

/* –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ */
.layout {
  display: flex;
  flex-direction: column;
  height: 100%;
}
.topbar {
  height: 60px;
  background: #222;
  color: white;
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.content {
  display: flex;
  height: calc(100% - 60px);
}
.left {
  flex: 1;
  padding: 8px;
  display: flex;
  flex-direction: column;
}
.categories {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
.cat-btn {
  padding: 10px 14px;
  font-size: 16px;
  background: #444;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
.grid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 6px;
  padding-right: 6px;
}
.item {
  background: #2c2c2c;
  border-radius: 6px;
  padding: 4px;
  text-align: center;
  height: 140px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
}
.item img {
  width: 100%;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
}
.item-name {
  font-size: 13px;
  margin-top: 4px;
}
.item-price {
  font-size: 14px;
  font-weight: bold;
  color: #ffc107;
  margin-top: 2px;
}

/* –ö–æ—Ä–∑–∏–Ω–∞ */
.cart-panel {
  width: 300px;
  background: #2a2a2a;
  display: flex;
  flex-direction: column;
  height: 100%;
}
.cart-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  overflow-y: auto;
}
.cart-panel h2 {
  font-size: 18px;
  margin-bottom: 6px;
}
#cart-items {
  flex: 1;
  overflow-y: auto;
  border: 1px solid #444;
  border-radius: 6px;
  background: #1f1f1f;
  margin-bottom: 8px;
}
#cart-items li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px;
  font-size: 14px;
}
.cart-total {
  font-size: 16px;
  margin: 6px 0;
}
.cash-box input {
  font-size: 16px;
  padding: 8px;
  border-radius: 4px;
  width: 100%;
}
.cart-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}
.cart-actions button {
  flex: 1;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
#btn-checkout {
  background: #28a745;
  color: white;
}
#btn-clear {
  background: #ff4d4d;
  color: white;
}
.product-scroll {
  flex: 1;
  overflow-y: auto;
  max-height: calc(768px - 60px - 90px);
}

/* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 100000; /* –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö */
}
.modal-content {
  background: #2c2c2c;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  width: 300px;
  max-width: 90%;
  box-sizing: border-box;
  color: white;
}
.modal-content h2 {
  margin-bottom: 12px;
}
.modal-content input {
  width: 90%;
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
}
.modal-content button {
  margin-top: 12px;
  padding: 10px 16px;
  font-size: 16px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ */
#keyboard-modal .modal-content {
  background: #111;
  width: 320px;
}
#keyboard-modal input {
  width: 100%;
  font-size: 28px;
  padding: 10px;
  margin-bottom: 15px;
  text-align: center;
  border: none;
  border-radius: 8px;
  background: #222;
  color: #fff;
}
.keyboard {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.keyboard button {
  font-size: 24px;
  padding: 20px;
  background: #333;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.keyboard button:hover {
  background: #555;
}
.keyboard button.ok {
  grid-column: span 3;
  background: #0a0;
  font-weight: bold;
}
</style>



</head>

<body>


<div class="layout">
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="employee" id="employeeName">
      –ö–∞—Å—Å–∏—Ä: {{ employee.name|default:"–ù–µ –≤—ã–±—Ä–∞–Ω–æ" }}
      {% if employee and employee.role == "–∞–¥–º–∏–Ω" %}
        <a href="{% url 'report_by_date' %}" style="margin-left: 20px; font-weight: bold; color: white;">–û—Ç—á—ë—Ç</a>
      {% endif %}
      <a href="{% url 'orders_list' %}" style="margin-left: 20px; font-weight: bold; color: white;">–ó–∞–∫–∞–∑—ã</a>
      <a href="{% url 'logout' %}" style="margin-left: 20px; font-weight: bold; color: #ff4d4d;">–í—ã—Ö–æ–¥</a>
      {% if employee and employee.role == "–∞–¥–º–∏–Ω" %}
        <a href="/admin/" style="margin-left: 20px; font-weight: bold; color: #ffc107;">–ê–¥–º–∏–Ω–∫–∞</a>
      {% endif %}
    </div>
  </header>

  <main class="content">
    <section class="left">
      <div class="categories">
        {% for cat in categories %}
          <button class="cat-btn" data-cat="{{ cat }}">{{ cat|title }}</button>
        {% empty %}
          <p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        {% endfor %}
      </div>

      <div class="product-scroll">
        <div class="grid" id="product-grid">
          {% for p in products %}
          <div class="item"
               data-category="{{ p.category }}"
               data-id="{{ p.id }}"
               data-name="{{ p.name }}"
               data-price="{{ p.price }}">
            <img src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}"
                 alt="{{ p.name }}">
            <div class="item-name">{{ p.name }}</div>
            <div class="item-price">{{ p.price }} —Å–æ–º</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <aside class="cart-panel">
      <div class="cart-inner">
        <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <ul id="cart-items"></ul>

        <div class="cart-total">–ò—Ç–æ–≥–æ: <span id="cart-total">0</span> —Å–æ–º</div>

        <div class="cash-box">
          <label for="cashGiven">–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:</label>
<input id="cashGiven" type="text" readonly placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" onclick="openKeyboard('amount')" />
<div class="change">–°–¥–∞—á–∞: <span id="changeAmount">0</span> —Å–æ–º</div>
        </div>

        <textarea id="order-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É" rows="2"></textarea>

        <div class="cart-actions">
          <button id="btn-checkout">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
          <button id="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </aside>
  </main>
</div>
<div id="notify" class="notify"></div>

<script>
  window.EMPLOYEE_ID = {% if employee and employee.id %}{{ employee.id }}{% else %}null{% endif %};
</script>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var pinModal = document.getElementById('pinModal');
    var pinInput = document.getElementById('pinInput');
    var pinSubmit = document.getElementById('pinSubmit');
    var pinError = document.getElementById('pinError');

    if (!pinModal) return;

    if (pinInput) pinInput.focus();

    function showError(msg) {
      if (pinError) {
        pinError.textContent = msg || '–ù–µ–≤–µ—Ä–Ω—ã–π PIN';
        pinError.style.display = 'block';
      }
    }
    function hideError() {
      if (pinError) pinError.style.display = 'none';
    }

    async function submitPin() {
      try {
        hideError();
        var pin = (pinInput && pinInput.value || '').trim();
        if (!pin) {
          showError('–í–≤–µ–¥–∏—Ç–µ PIN');
          return;
        }
        var resp = await fetch('/employee/get-id/?pin=' + encodeURIComponent(pin));
        if (!resp.ok) {
          showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (' + resp.status + ')');
          return;
        }
        var data = await resp.json();
        if (data && data.id) {
          // —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –º–µ–Ω—é —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫–∞—Å—Å–∏—Ä–∞
          window.location.href = '/menu/?emp=' + data.id;
        } else {
          showError('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PIN:', e);
        showError('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞');
      }
    }

    if (pinSubmit) pinSubmit.addEventListener('click', submitPin);
    if (pinInput) {
      pinInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') submitPin();
      });
    }
  });
})();
</script>

<script>
(function() {
  function updateChange() {
    const cashInput = document.getElementById('cashGiven');
    const changeSpan = document.getElementById('changeAmount');
    const totalSpan = document.getElementById('cart-total');

    if (!cashInput || !changeSpan || !totalSpan) return;

    // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –∏–∑ total, —É–±–∏—Ä–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, —Ç–æ—á–∫–∏ –∏ –º–∏–Ω—É—Å–∞
    const totalText = (totalSpan.textContent || '').replace(/[^\d.-]/g, '');
    const total = parseFloat(totalText) || 0;
    const cash = parseFloat(cashInput.value) || 0;
    const change = cash - total;

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
    changeSpan.textContent = change.toFixed(2);

    // —Ü–≤–µ—Ç–æ–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    if (change >= 0) {
      changeSpan.classList.add('positive');
      changeSpan.classList.remove('negative');
    } else {
      changeSpan.classList.add('negative');
      changeSpan.classList.remove('positive');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const cashInput = document.getElementById('cashGiven');
    if (cashInput) {
      cashInput.addEventListener('input', updateChange);
    }

    const cartTotal = document.getElementById('cart-total');
    if (cartTotal) {
      const observer = new MutationObserver(updateChange);
      observer.observe(cartTotal, { childList: true });
    }

    updateChange(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
  });
})();

document.addEventListener('DOMContentLoaded', function() {
  const btnCheckout = document.getElementById('btn-checkout');
  const btnClear = document.getElementById('btn-clear');
  const cashInput = document.getElementById('cashGiven');
  const changeSpan = document.getElementById('changeAmount');
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');

  function clearCalculator() {
    if (cashInput) cashInput.value = '';
    if (changeSpan) {
      changeSpan.textContent = '0';
      changeSpan.classList.remove('positive', 'negative');
    }
  }

  function clearCart() {
    if (cartItems) cartItems.innerHTML = '';
    if (cartTotal) cartTotal.textContent = '0';
    clearCalculator();
  }

  if (btnCheckout) {
    btnCheckout.addEventListener('click', function() {
      // –∑–¥–µ—Å—å —Ç–≤–æ—è –ª–æ–≥–∏–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (–æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
      // –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –æ—á–∏—â–∞–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏ –∫–æ—Ä–∑–∏–Ω—É:
      clearCart();
    });
  }

  if (btnClear) {
    btnClear.addEventListener('click', function() {
      clearCart();
    });
  }
});

let currentTarget = null;

// –û—Ç–∫—Ä—ã—Ç–∏–µ —ç–∫—Ä–∞–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
function openKeyboard(target) {
  currentTarget = target;
  const modal = document.getElementById("keyboard-modal");
  const display = document.getElementById("keyboard-display");
  if (!modal || !display) return;

  modal.style.display = "flex";
  display.value = "";
  display.setAttribute("type", target === "pin" ? "password" : "text");
}

// –í–≤–æ–¥ —Ü–∏—Ñ—Ä—ã
function pressKey(val) {
  const display = document.getElementById("keyboard-display");
  if (display) display.value += val;
}

// –û—á–∏—Å—Ç–∫–∞
function clearInput() {
  const display = document.getElementById("keyboard-display");
  if (display) display.value = "";
}

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–º–≤–æ–ª–∞
function backspace() {
  const display = document.getElementById("keyboard-display");
  if (display) display.value = display.value.slice(0, -1);
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ PIN, —Å—É–º–º—ã –∏ —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
function submitKeyboard() {
  const val = document.getElementById("keyboard-display").value;

  if (currentTarget === "pin") {
    const pinInput = document.getElementById("pin-input");
    if (pinInput) pinInput.value = val;

    if (!val) return notify("–í–≤–µ–¥–∏—Ç–µ PIN", "error");

    // üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
    if (val === "0909") {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–∏—è
      fetch("/shutdown/", { method: "POST" })
        .then(() => {
          notify("–°–∏—Å—Ç–µ–º–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è...", "success");
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏:", err);
          notify("–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è", "error");
        });
      return;
    }

    // –û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ PIN
    fetch(`/employee/get-id/?pin=${encodeURIComponent(val)}`)
      .then(res => res.json())
      .then(data => {
        if (data.id) {
          window.location.href = `/menu/?emp=${data.id}`;
        } else {
          notify("–ù–µ–≤–µ—Ä–Ω—ã–π PIN", "error");
        }
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PIN:", err);
        notify("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è", "error");
      });
  } else if (currentTarget === "amount") {
    const cashInput = document.getElementById("cashGiven");
    if (cashInput) {
      cashInput.value = val;
      updateChange(); // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å–¥–∞—á—É
    }
  }

  document.getElementById("keyboard-modal").style.display = "none";
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function notify(msg, type = "success") {
  const box = document.getElementById('notify');
  if (!box) return;
  box.textContent = msg;
  box.className = "notify " + (type === "error" ? "error show" : "show");
  setTimeout(() => { box.className = "notify"; }, 2000);
}

// –ü–µ—Ä–µ—Å—á—ë—Ç —Å–¥–∞—á–∏
function updateChange() {
  const cashInput = document.getElementById('cashGiven');
  const changeSpan = document.getElementById('changeAmount');
  const totalSpan = document.getElementById('cart-total');

  if (!cashInput || !changeSpan || !totalSpan) return;

  const totalText = (totalSpan.textContent || '').replace(/[^\d.-]/g, '');
  const total = parseFloat(totalText) || 0;
  const cash = parseFloat(cashInput.value) || 0;
  const change = cash - total;

  changeSpan.textContent = change.toFixed(2);

  if (change >= 0) {
    changeSpan.classList.add('positive');
    changeSpan.classList.remove('negative');
  } else {
    changeSpan.classList.add('negative');
    changeSpan.classList.remove('positive');
  }
}

// –û—á–∏—Å—Ç–∫–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
function clearCalculator() {
  const cashInput = document.getElementById('cashGiven');
  const changeSpan = document.getElementById('changeAmount');
  if (cashInput) cashInput.value = '';
  if (changeSpan) {
    changeSpan.textContent = '0';
    changeSpan.classList.remove('positive', 'negative');
  }
}

// –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
function clearCart() {
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');
  if (cartItems) cartItems.innerHTML = '';
  if (cartTotal) cartTotal.textContent = '0';
  clearCalculator();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
document.addEventListener('DOMContentLoaded', function() {
  const btnCheckout = document.getElementById('btn-checkout');
  const btnClear = document.getElementById('btn-clear');
  const cashInput = document.getElementById('cashGiven');
  const cartTotal = document.getElementById('cart-total');

  if (btnCheckout) btnCheckout.addEventListener('click', clearCart);
  if (btnClear) btnClear.addEventListener('click', clearCart);
  if (cashInput) cashInput.addEventListener('input', updateChange);

  if (cartTotal) {
    const observer = new MutationObserver(updateChange);
    observer.observe(cartTotal, { childList: true });
  }

  updateChange(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
});

// –ü–æ–∫–∞–∑–∞—Ç—å PIN-–º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const modal = document.getElementById('pinModal');
  if (!urlParams.has('emp') && modal) {
    modal.style.display = 'flex';
  }
});


</script>
{% if not employee %}
<div id="pinModal" class="modal" aria-hidden="false">
  <div class="modal-content">
    <h2>–í–≤–µ–¥–∏—Ç–µ PIN –∫–∞—Å—Å–∏—Ä–∞</h2>
    <input id="pin-input" type="password" readonly placeholder="–í–≤–µ–¥–∏—Ç–µ PIN" onclick="openKeyboard('pin')" />
    <p id="pinError" style="color:red; display:none; margin-top:8px;">–ù–µ–≤–µ—Ä–Ω—ã–π PIN</p>
  </div>
</div>
{% endif %}

<div id="keyboard-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <input id="keyboard-display" type="text" readonly />
    <div class="keyboard">
      <button onclick="pressKey('1')">1</button>
      <button onclick="pressKey('2')">2</button>
      <button onclick="pressKey('3')">3</button>
      <button onclick="pressKey('4')">4</button>
      <button onclick="pressKey('5')">5</button>
      <button onclick="pressKey('6')">6</button>
      <button onclick="pressKey('7')">7</button>
      <button onclick="pressKey('8')">8</button>
      <button onclick="pressKey('9')">9</button>
      <button onclick="pressKey('0')">0</button>
      <button onclick="clearInput()">C</button>
      <button onclick="backspace()">‚Üê</button>
      <button class="ok" onclick="submitKeyboard()">OK</button>
    </div>
  </div>
</div>

</body>

</html>
