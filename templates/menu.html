{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–∞—Å—Å–∞ ‚Äî –ú–µ–Ω—é</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script defer src="{% static 'js/cart.js' %}"></script>

</head>

<body>

{% if not employee %}
<div id="pinModal" class="modal" aria-hidden="false">
  <div class="modal-content">
    <h2>–í–≤–µ–¥–∏—Ç–µ PIN –∫–∞—Å—Å–∏—Ä–∞</h2>
    <input type="password" id="pinInput" placeholder="PIN" autocomplete="off" />
    <button id="pinSubmit">–í–æ–π—Ç–∏</button>
    <p id="pinError" style="color:red; display:none; margin-top:8px;">–ù–µ–≤–µ—Ä–Ω—ã–π PIN</p>
  </div>
</div>
{% endif %}

<style>
.modal {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;
}
.modal[aria-hidden="true"] { display: none; }
.modal-content {
  background: #fff; padding: 20px; border-radius: 8px; text-align: center; width: 320px;
}
</style>

<div class="layout">
   <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="employee" id="employeeName">
        –ö–∞—Å—Å–∏—Ä: {{ employee.name|default:"–ù–µ –≤—ã–±—Ä–∞–Ω–æ" }}
        {% if employee and employee.role == "–∞–¥–º–∏–Ω" %}
<a href="{% url 'report_by_date' %}" style="margin-left: 20px; font-weight: bold; color: white;">–û—Ç—á—ë—Ç</a>
{% endif %}

        <a href="{% url 'orders_list' %}" style="margin-left: 20px; font-weight: bold; color: white;">–ó–∞–∫–∞–∑—ã</a>
        <a href="{% url 'logout' %}" style="margin-left: 20px; font-weight: bold; color: #ff4d4d;">–í—ã—Ö–æ–¥</a>

        {% if employee and employee.role == "–∞–¥–º–∏–Ω" %}
        <a href="/admin/" style="margin-left: 20px; font-weight: bold; color: #ffc107;">–ê–¥–º–∏–Ω–∫–∞</a>
        {% endif %}
    </div>
</header>



    <main class="content">
        <section class="left">
            <div class="categories">
                {% for cat in categories %}
                    <button class="cat-btn" data-cat="{{ cat }}">{{ cat|title }}</button>
                {% empty %}
                    <p>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                {% endfor %}
            </div>

            <div class="grid" id="product-grid">
                {% for p in products %}
                <div class="item"
                     data-category="{{ p.category }}"
                     data-id="{{ p.id }}"
                     data-name="{{ p.name }}"
                     data-price="{{ p.price }}">
                    <img src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}"
                         alt="{{ p.name }}">
                    <div class="item-name">{{ p.name }}</div>
                    <div class="item-price">{{ p.price }} —Å–æ–º</div>
                </div>
                {% endfor %}
            </div>
        </section>

<aside class="cart-panel">
    <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
    <ul id="cart-items"></ul>

    <div class="cart-total">–ò—Ç–æ–≥–æ: <span id="cart-total">0</span> —Å–æ–º</div>



    <!-- üîπ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–¥–∞—á–∏ -->
    <div class="cash-box">
        <label for="cashGiven">–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:</label>
        <input type="number" id="cashGiven" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" />
        <div class="change">–°–¥–∞—á–∞: <span id="changeAmount">0</span> —Å–æ–º</div>
    </div>

<textarea id="order-note" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É" rows="2"></textarea>

    <div class="cart-actions">
        <button id="submitOrderBtn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        <button id="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>

</aside>


    </main>
</div>

<script>
  window.EMPLOYEE_ID = {% if employee and employee.id %}{{ employee.id }}{% else %}null{% endif %};
</script>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var pinModal = document.getElementById('pinModal');
    var pinInput = document.getElementById('pinInput');
    var pinSubmit = document.getElementById('pinSubmit');
    var pinError = document.getElementById('pinError');

    if (!pinModal) return;

    if (pinInput) pinInput.focus();

    function showError(msg) {
      if (pinError) {
        pinError.textContent = msg || '–ù–µ–≤–µ—Ä–Ω—ã–π PIN';
        pinError.style.display = 'block';
      }
    }
    function hideError() {
      if (pinError) pinError.style.display = 'none';
    }

    async function submitPin() {
      try {
        hideError();
        var pin = (pinInput && pinInput.value || '').trim();
        if (!pin) {
          showError('–í–≤–µ–¥–∏—Ç–µ PIN');
          return;
        }
        var resp = await fetch('/employee/get-id/?pin=' + encodeURIComponent(pin));
        if (!resp.ok) {
          showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (' + resp.status + ')');
          return;
        }
        var data = await resp.json();
        if (data && data.id) {
          // ‚úÖ –≤–º–µ—Å—Ç–æ —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
          window.location.href = '/menu/?emp=' + data.id;
        } else {
          showError('–ù–µ–≤–µ—Ä–Ω—ã–π PIN');
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ PIN:', e);
        showError('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞');
      }
    }

    if (pinSubmit) pinSubmit.addEventListener('click', submitPin);
    if (pinInput) {
      pinInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') submitPin();
      });
    }
  });
})();
<!-- –ö–Ω–æ–ø–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ -->


document.getElementById("submitOrderBtn").addEventListener("click", function() {
    // –ø—Ä–∏–º–µ—Ä: –ø–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞ –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    let orderId = 91;  // –∑–∞–º–µ–Ω–∏—à—å –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π ID

    // –≤—ã–∑—ã–≤–∞–µ–º Django view –¥–ª—è –ø–µ—á–∞—Ç–∏
    fetch(`/orders/${orderId}/receipt/`, {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.ok) {
            // ‚úÖ —á–µ–∫ —É–∂–µ —É—à—ë–ª –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä
            console.log("–ß–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω –¥–ª—è –∑–∞–∫–∞–∑–∞ ‚Ññ" + data.order_id);

            // –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞—Å—Å–∏—Ä—É
            alert("–ß–µ–∫ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω!");
        }
    })
    .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏:", err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ —á–µ–∫–∞");
    });
});
</script>
</body>
<script>
(function() {
  function updateChange() {
    const cashInput = document.getElementById('cashGiven');
    const changeSpan = document.getElementById('changeAmount');
    const totalSpan = document.getElementById('cart-total');

    if (!cashInput || !changeSpan || !totalSpan) return;

    // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –∏–∑ total, —É–±–∏—Ä–∞–µ–º –≤—Å—ë –ª–∏—à–Ω–µ–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä, —Ç–æ—á–∫–∏ –∏ –º–∏–Ω—É—Å–∞
    const totalText = (totalSpan.textContent || '').replace(/[^\d.-]/g, '');
    const total = parseFloat(totalText) || 0;
    const cash = parseFloat(cashInput.value) || 0;
    const change = cash - total;

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
    changeSpan.textContent = change.toFixed(2);

    // —Ü–≤–µ—Ç–æ–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    if (change >= 0) {
      changeSpan.classList.add('positive');
      changeSpan.classList.remove('negative');
    } else {
      changeSpan.classList.add('negative');
      changeSpan.classList.remove('positive');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const cashInput = document.getElementById('cashGiven');
    if (cashInput) {
      cashInput.addEventListener('input', updateChange);
    }

    const cartTotal = document.getElementById('cart-total');
    if (cartTotal) {
      const observer = new MutationObserver(updateChange);
      observer.observe(cartTotal, { childList: true });
    }

    updateChange(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
  });
})();
</script>



</html>


