{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Касса — Меню</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <script defer src="{% static 'js/cart.js' %}"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
      font-size: 18px;
      overflow: hidden; /* без вертикальной прокрутки страницы */
    }
    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .topbar {
      background: #222;
      color: white;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
    }
    .content {
      display: flex;
      flex: 1;
      overflow: hidden; /* ограничиваем прокрутку внутри основных колонок */
    }
    .left {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Категории — в одну строку, прокрутка по горизонтали */
    .categories {
      display: flex;
      overflow-x: auto;
      gap: 10px;
      padding-bottom: 10px;
    }
    .categories::-webkit-scrollbar { height: 6px; }
    .categories::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
    .cat-btn {
      flex: 0 0 auto;
      padding: 18px;
      font-size: 20px;
      background: #444;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    .cat-btn:hover { background: #ffc107; color: black; }

    /* Сетка товаров — одинаковые карточки */
    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
      overflow-y: auto; /* если товаров много, скролл только здесь */
      max-height: calc(100vh - 240px); /* учитываем верхнюю панель и блок категорий */
    }
    .item {
      background: #2c2c2c;
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
    }
    .item-name { font-size: 18px; margin-top: 8px; }
    .item-price { font-size: 20px; font-weight: bold; color: #ffc107; margin-top: 4px; }
    .item:active { transform: scale(0.98); outline: 2px solid #ffc107; }

    /* Корзина справа — фиксированная высота и внутренняя прокрутка */
    .cart-panel {
      width: 340px;
      background: #2a2a2a;
      padding: 16px;
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 60px); /* 60px примерно высота топбара */
      overflow: hidden;
    }
    .cart-panel h2 { font-size: 22px; margin-bottom: 10px; }

    #cart-items {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 8px;
      background: #1f1f1f;
    }
    #cart-items li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid #3a3a3a;
      font-size: 18px;
    }
    #cart-items li:last-child { border-bottom: none; }
    .cart-item-name { flex: 1; margin-right: 8px; }
    .cart-item-qty { display: inline-flex; gap: 8px; align-items: center; }
    .qty-btn {
      width: 34px;
      height: 34px;
      border: none;
      border-radius: 6px;
      background: #444;
      color: white;
      font-size: 20px;
      cursor: pointer;
      user-select: none;
    }
    .qty-btn:active { transform: scale(0.96); background: #555; }
    .remove-btn {
      margin-left: 8px;
      background: #ff4d4d;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 16px;
    }

    .cart-total { font-size: 20px; margin: 10px 0; }

    /* Калькулятор сдачи — крупные элементы */
    .cash-box label { font-size: 18px; }
    .cash-box input {
      width: 100%;
      padding: 14px;
      font-size: 20px;
      margin-top: 6px;
      border-radius: 6px;
      border: 2px solid #555;
      background: #1a1a1a;
      color: #f0f0f0;
    }
    .change { margin-top: 10px; font-size: 20px; }
    .change .positive { color: #28a745; }
    .change .negative { color: #ff4d4d; }

    /* Комментарий к заказу */
    textarea#order-note {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      margin-top: 10px;
      border-radius: 6px;
      border: 2px solid #555;
      background: #1a1a1a;
      color: #f0f0f0;
      resize: none;
    }

    /* Кнопки оформления */
    .cart-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    .cart-actions button {
      flex: 1;
      padding: 18px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    #btn-checkout { background: #28a745; color: white; }
    #btn-clear { background: #ff4d4d; color: white; }

    /* PIN модалка — оставлена, но стилизована для удобства */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
    }
    .modal[aria-hidden="true"] { display: none; }
    .modal-content {
      background: #fff; padding: 20px; border-radius: 8px;
      text-align: center; width: 340px;
    }
    .modal-content input {
      width: 80%;
      padding: 14px;
      font-size: 20px;
      margin-top: 10px;
      border-radius: 6px;
      border: 2px solid #555;
    }
    .modal-content button {
      width: 100%;
      padding: 16px;
      font-size: 20px;
      margin-top: 12px;
      border: none;
      border-radius:8px;
      background: #28a745;
      color: white;
      cursor: pointer;
    }
  </style>
</head>

<body>

{% if not employee %}
<div id="pinModal" class="modal" aria-hidden="false">
  <div class="modal-content">
    <h2>Введите PIN кассира</h2>
    <input type="password" id="pinInput" placeholder="PIN" autocomplete="off" />
    <button id="pinSubmit">Войти</button>
    <p id="pinError" style="color:red; display:none; margin-top:8px;">Неверный PIN</p>
  </div>
</div>
{% endif %}

<div class="layout">
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="employee" id="employeeName">
      Кассир: {{ employee.name|default:"Не выбрано" }}
      {% if employee and employee.role == "админ" %}
        <a href="{% url 'report_by_date' %}" style="margin-left: 20px; font-weight: bold; color: white;">Отчёт</a>
      {% endif %}
      <a href="{% url 'orders_list' %}" style="margin-left: 20px; font-weight: bold; color: white;">Заказы</a>
      <a href="{% url 'logout' %}" style="margin-left: 20px; font-weight: bold; color: #ff4d4d;">Выход</a>
      {% if employee and employee.role == "админ" %}
        <a href="/admin/" style="margin-left: 20px; font-weight: bold; color: #ffc107;">Админка</a>
      {% endif %}
    </div>
  </header>

  <main class="content">
    <section class="left">
      <div class="categories">
        {% for cat in categories %}
          <button class="cat-btn" data-cat="{{ cat }}">{{ cat|title }}</button>
        {% empty %}
          <p>Категории не найдены</p>
        {% endfor %}
      </div>

      <div class="grid" id="product-grid">
        {% for p in products %}
        <div class="item"
             data-category="{{ p.category }}"
             data-id="{{ p.id }}"
             data-name="{{ p.name }}"
             data-price="{{ p.price }}">
          <img src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}"
               alt="{{ p.name }}">
          <div class="item-name">{{ p.name }}</div>
          <div class="item-price">{{ p.price }} сом</div>
        </div>
        {% endfor %}
      </div>
    </section>

    <aside class="cart-panel">
      <h2>Корзина</h2>
      <ul id="cart-items"></ul>

      <div class="cart-total">Итого: <span id="cart-total">0</span> сом</div>

      <div class="cash-box">
        <label for="cashGiven">Получено от клиента:</label>
        <input type="number" id="cashGiven" placeholder="Введите сумму" />
        <div class="change">Сдача: <span id="changeAmount">0</span> сом</div>
      </div>

      <textarea id="order-note" placeholder="Комментарий к заказу" rows="2"></textarea>

      <div class="cart-actions">
        <button id="btn-checkout">Оформить заказ</button>
        <button id="btn-clear">Очистить</button>
      </div>
    </aside>
  </main>
</div>

<script>
  window.EMPLOYEE_ID = {% if employee and employee.id %}{{ employee.id }}{% else %}null{% endif %};
</script>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var pinModal = document.getElementById('pinModal');
    var pinInput = document.getElementById('pinInput');
    var pinSubmit = document.getElementById('pinSubmit');
    var pinError = document.getElementById('pinError');

    if (!pinModal) return;

    if (pinInput) pinInput.focus();

    function showError(msg) {
      if (pinError) {
        pinError.textContent = msg || 'Неверный PIN';
        pinError.style.display = 'block';
      }
    }
    function hideError() {
      if (pinError) pinError.style.display = 'none';
    }

    async function submitPin() {
      try {
        hideError();
        var pin = (pinInput && pinInput.value || '').trim();
        if (!pin) {
          showError('Введите PIN');
          return;
        }
        var resp = await fetch('/employee/get-id/?pin=' + encodeURIComponent(pin));
        if (!resp.ok) {
          showError('Ошибка подключения (' + resp.status + ')');
          return;
        }
        var data = await resp.json();
        if (data && data.id) {
          // редирект на меню с привязкой кассира
          window.location.href = '/menu/?emp=' + data.id;
        } else {
          showError('Неверный PIN');
        }
      } catch (e) {
        console.error('Ошибка при проверке PIN:', e);
        showError('Неожиданная ошибка');
      }
    }

    if (pinSubmit) pinSubmit.addEventListener('click', submitPin);
    if (pinInput) {
      pinInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') submitPin();
      });
    }
  });
})();
</script>

<script>
(function() {
  function updateChange() {
    const cashInput = document.getElementById('cashGiven');
    const changeSpan = document.getElementById('changeAmount');
    const totalSpan = document.getElementById('cart-total');

    if (!cashInput || !changeSpan || !totalSpan) return;

    // берём только число из total, убираем всё лишнее кроме цифр, точки и минуса
    const totalText = (totalSpan.textContent || '').replace(/[^\d.-]/g, '');
    const total = parseFloat(totalText) || 0;
    const cash = parseFloat(cashInput.value) || 0;
    const change = cash - total;

    // показываем как есть (может быть отрицательным)
    changeSpan.textContent = change.toFixed(2);

    // цветовое оформление
    if (change >= 0) {
      changeSpan.classList.add('positive');
      changeSpan.classList.remove('negative');
    } else {
      changeSpan.classList.add('negative');
      changeSpan.classList.remove('positive');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const cashInput = document.getElementById('cashGiven');
    if (cashInput) {
      cashInput.addEventListener('input', updateChange);
    }

    const cartTotal = document.getElementById('cart-total');
    if (cartTotal) {
      const observer = new MutationObserver(updateChange);
      observer.observe(cartTotal, { childList: true });
    }

    updateChange(); // первый запуск
  });
})();

document.addEventListener('DOMContentLoaded', function() {
  const btnCheckout = document.getElementById('btn-checkout');
  const btnClear = document.getElementById('btn-clear');
  const cashInput = document.getElementById('cashGiven');
  const changeSpan = document.getElementById('changeAmount');
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');

  function clearCalculator() {
    if (cashInput) cashInput.value = '';
    if (changeSpan) {
      changeSpan.textContent = '0';
      changeSpan.classList.remove('positive', 'negative');
    }
  }

  function clearCart() {
    if (cartItems) cartItems.innerHTML = '';
    if (cartTotal) cartTotal.textContent = '0';
    clearCalculator();
  }

  if (btnCheckout) {
    btnCheckout.addEventListener('click', function() {
      // здесь твоя логика оформления заказа (отправка на сервер)
      // после успешного оформления очищаем калькулятор и корзину:
      clearCart();
    });
  }

  if (btnClear) {
    btnClear.addEventListener('click', function() {
      clearCart();
    });
  }
});

</script>

</body>
</html>
