{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Касса — Меню</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <script defer src="{% static 'js/cart.js' %}"></script>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #1e1e1e;
  color: #f0f0f0;
  font-size: 16px;
  width: 1024px;
  height: 768px;
  overflow: hidden;
}

/* Основная структура */
.layout {
  display: flex;
  flex-direction: column;
  width: 1024px;
  height: 768px;
}
.topbar {
  height: 60px;
  background: #222;
  color: white;
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.content {
  display: flex;
  height: calc(768px - 60px);
}
.left {
  width: 724px; /* 1024 - 300 */
  padding: 8px;
  display: flex;
  flex-direction: column;
}
.categories {
  display: flex;
  flex-wrap: nowrap;
  gap: 6px;
  margin-bottom: 6px;
  overflow-x: auto;
  max-width: 724px;
}
.cat-btn {
  padding: 10px 14px;
  font-size: 16px;
  background: #444;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* Сетка товаров */
.grid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  grid-auto-rows: 140px;
  gap: 6px;
  overflow: hidden; /* убираем скролл */
}
.item {
  background: #2c2c2c;
  border-radius: 6px;
  padding: 4px;
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
}
.item img {
  width: 100%;
  height: 60px;
  object-fit: cover;
  border-radius: 4px;
}
.item-name {
  font-size: 13px;
  margin-top: 4px;
}
.item-price {
  font-size: 14px;
  font-weight: bold;
  color: #ffc107;
  margin-top: 2px;
}

/* Корзина */
.cart-panel {
  width: 300px;
  background: #2a2a2a;
  display: flex;
  flex-direction: column;
  height: 708px; /* 768 - 60 */
}
.cart-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  overflow: hidden; /* убираем скролл */
}
.cart-panel h2 {
  font-size: 18px;
  margin-bottom: 6px;
}
#cart-items {
  flex: 1;
  border: 1px solid #444;
  border-radius: 6px;
  background: #1f1f1f;
  margin-bottom: 8px;
}
#cart-items li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px;
  font-size: 14px;
}
.cart-total {
  font-size: 16px;
  margin: 6px 0;
}
.cash-box input {
  font-size: 16px;
  padding: 8px;
  border-radius: 4px;
  width: 100%;
}
.cart-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}
.cart-actions button {
  flex: 1;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
#btn-checkout {
  background: #28a745;
  color: white;
}
#btn-clear {
  background: #ff4d4d;
  color: white;
}

/* Модальные окна */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 100000;
}
.modal-content {
  background: #2c2c2c;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  width: 300px;
  max-width: 90%;
  box-sizing: border-box;
  color: white;
}
.modal-content h2 {
  margin-bottom: 12px;
}
.modal-content input {
  width: 90%;
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
}
.modal-content button {
  margin-top: 12px;
  padding: 10px 16px;
  font-size: 16px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

/* Клавиатура */
#keyboard-modal .modal-content {
  background: #111;
  width: 320px;
}
#keyboard-modal input {
  width: 100%;
  font-size: 28px;
  padding: 10px;
  margin-bottom: 15px;
  text-align: center;
  border: none;
  border-radius: 8px;
  background: #222;
  color: #fff;
}
.keyboard {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}
.keyboard button {
  font-size: 24px;
  padding: 20px;
  background: #333;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}
.keyboard button:hover {
  background: #555;
}
.keyboard button.ok {
  grid-column: span 3;
  background: #0a0;
  font-weight: bold;
}
</style>




</head>

<body>


<div class="layout">
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="employee" id="employeeName">
      Кассир: {{ employee.name|default:"Не выбрано" }}
      {% if employee and employee.role == "админ" %}
        <a href="{% url 'report_by_date' %}" style="margin-left: 20px; font-weight: bold; color: white;">Отчёт</a>
      {% endif %}
      <a href="{% url 'orders_list' %}" style="margin-left: 20px; font-weight: bold; color: white;">Заказы</a>
      <a href="{% url 'logout' %}" style="margin-left: 20px; font-weight: bold; color: #ff4d4d;">Выход</a>
      {% if employee and employee.role == "админ" %}
        <a href="/admin/" style="margin-left: 20px; font-weight: bold; color: #ffc107;">Админка</a>
      {% endif %}
    </div>
  </header>

  <main class="content">
    <section class="left">
      <div class="categories">
        {% for cat in categories %}
          <button class="cat-btn" data-cat="{{ cat }}">{{ cat|title }}</button>
        {% empty %}
          <p>Категории не найдены</p>
        {% endfor %}
      </div>

      <div class="product-scroll">
        <div class="grid" id="product-grid">
          {% for p in products %}
          <div class="item"
               data-category="{{ p.category }}"
               data-id="{{ p.id }}"
               data-name="{{ p.name }}"
               data-price="{{ p.price }}">
            <img src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}"
                 alt="{{ p.name }}">
            <div class="item-name">{{ p.name }}</div>
            <div class="item-price">{{ p.price }} сом</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <aside class="cart-panel">
      <div class="cart-inner">
        <h2>Корзина</h2>
        <ul id="cart-items"></ul>

        <div class="cart-total">Итого: <span id="cart-total">0</span> сом</div>

        <div class="cash-box">
          <label for="cashGiven">Получено от клиента:</label>
<input id="cashGiven" type="text" readonly placeholder="Введите сумму" onclick="openKeyboard('amount')" />
<div class="change">Сдача: <span id="changeAmount">0</span> сом</div>
        </div>

        <textarea id="order-note" placeholder="Комментарий к заказу" rows="2"></textarea>

        <div class="cart-actions">
          <button id="btn-checkout">Оформить заказ</button>
          <button id="btn-clear">Очистить</button>
        </div>
      </div>
    </aside>
  </main>
</div>
<div id="notify" class="notify"></div>

<script>
  window.EMPLOYEE_ID = {% if employee and employee.id %}{{ employee.id }}{% else %}null{% endif %};
</script>

<script>
(function() {
  function updateChange() {
    const cashInput = document.getElementById('cashGiven');
    const changeSpan = document.getElementById('changeAmount');
    const totalSpan = document.getElementById('cart-total');

    if (!cashInput || !changeSpan || !totalSpan) return;

    const totalText = (totalSpan.textContent || '').replace(/[^\d.-]/g, '');
    const total = parseFloat(totalText) || 0;
    const cash = parseFloat(cashInput.value) || 0;
    const change = cash - total;

    changeSpan.textContent = change.toFixed(2);

    if (change >= 0) {
      changeSpan.classList.add('positive');
      changeSpan.classList.remove('negative');
    } else {
      changeSpan.classList.add('negative');
      changeSpan.classList.remove('positive');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const cashInput = document.getElementById('cashGiven');
    if (cashInput) {
      cashInput.addEventListener('input', updateChange);
    }

    const cartTotal = document.getElementById('cart-total');
    if (cartTotal) {
      const observer = new MutationObserver(updateChange);
      observer.observe(cartTotal, { childList: true });
    }

    updateChange();
  });
})();

document.addEventListener('DOMContentLoaded', function() {
  const btnCheckout = document.getElementById('btn-checkout');
  const btnClear = document.getElementById('btn-clear');
  const cashInput = document.getElementById('cashGiven');
  const changeSpan = document.getElementById('changeAmount');
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');

  function clearCalculator() {
    if (cashInput) cashInput.value = '';
    if (changeSpan) {
      changeSpan.textContent = '0';
      changeSpan.classList.remove('positive', 'negative');
    }
  }

  function clearCart() {
    if (cartItems) cartItems.innerHTML = '';
    if (cartTotal) cartTotal.textContent = '0';
    clearCalculator();
  }
if (btnCheckout) {
  btnCheckout.addEventListener('click', function() {
    const items = [];
    document.querySelectorAll('#cart-items .cart-item').forEach(el => {
      items.push({
        id: el.dataset.id,
        qty: el.dataset.qty,
        price: el.dataset.price
      });
    });

    const payload = {
      employee_id: document.getElementById('pin-input')?.value || 1,
      items: items,
      note: document.getElementById('order-note')?.value || ''
    };

    fetch("/orders/submit/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if (data.ok) {
        notify("Заказ оформлен №" + data.order_number, "success");
        // корзина остаётся как есть
      } else {
        notify("Ошибка: " + data.error, "error");
      }
    })
    .catch(err => {
      console.error("Ошибка оформления:", err);
      notify("Ошибка подключения", "error");
    });
  });
}


  if (btnClear) {
    btnClear.addEventListener('click', function() {
      clearCart();
    });
  }
});

let currentTarget = null;

function openKeyboard(target) {
  currentTarget = target;
  const modal = document.getElementById("keyboard-modal");
  const display = document.getElementById("keyboard-display");
  if (!modal || !display) return;

  modal.style.display = "flex";
  display.value = "";
  display.setAttribute("type", target === "pin" ? "password" : "text");
}

function pressKey(val) {
  const display = document.getElementById("keyboard-display");
  if (display) display.value += val;
}

function clearInput() {
  const display = document.getElementById("keyboard-display");
  if (display) display.value = "";
}

function backspace() {
  const display = document.getElementById("keyboard-display");
  if (display) display.value = display.value.slice(0, -1);
}

function submitKeyboard() {
  const val = document.getElementById("keyboard-display").value;

  if (currentTarget === "pin") {
    const pinInput = document.getElementById("pin-input");
    if (pinInput) pinInput.value = val;

    if (!val) return notify("Введите PIN", "error");

    if (val === "0909") {
      fetch("/shutdown/", { method: "POST" })
        .then(() => notify("Система закрывается...", "success"))
        .catch(err => {
          console.error("Ошибка при завершении:", err);
          notify("Ошибка завершения", "error");
        });
      return;
    }

    fetch(`/employee/get-id/?pin=${encodeURIComponent(val)}`)
      .then(res => res.json())
      .then(data => {
        if (data.id) {
          window.location.href = `/menu/?emp=${data.id}`;
        } else {
          notify("Неверный PIN", "error");
        }
      })
      .catch(err => {
        console.error("Ошибка при проверке PIN:", err);
        notify("Ошибка подключения", "error");
      });
  } else if (currentTarget === "amount") {
    const cashInput = document.getElementById("cashGiven");
    if (cashInput) {
      cashInput.value = val;
      updateChange();
    }
  }

  document.getElementById("keyboard-modal").style.display = "none";
}

function notify(msg, type = "success") {
  const box = document.getElementById('notify');
  if (!box) return;
  box.textContent = msg;
  box.className = "notify " + (type === "error" ? "error show" : "show");
  setTimeout(() => { box.className = "notify"; }, 2000);
}

window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const modal = document.getElementById('pinModal');
  if (!urlParams.has('emp') && modal) {
    modal.style.display = 'flex';
  }
});
</script>

{% if not employee %}
<div id="pinModal" class="modal" aria-hidden="false">
  <div class="modal-content">
    <h2>Введите PIN кассира</h2>
    <input id="pin-input" type="password" readonly placeholder="Введите PIN" onclick="openKeyboard('pin')" />
    <p id="pinError" style="color:red; display:none; margin-top:8px;">Неверный PIN</p>
  </div>
</div>
{% endif %}

<div id="keyboard-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <input id="keyboard-display" type="text" readonly />
    <div class="keyboard">
      <button onclick="pressKey('1')">1</button>
      <button onclick="pressKey('2')">2</button>
      <button onclick="pressKey('3')">3</button>
      <button onclick="pressKey('4')">4</button>
      <button onclick="pressKey('5')">5</button>
      <button onclick="pressKey('6')">6</button>
      <button onclick="pressKey('7')">7</button>
      <button onclick="pressKey('8')">8</button>
      <button onclick="pressKey('9')">9</button>
      <button onclick="pressKey('0')">0</button>
      <button onclick="clearInput()">C</button>
      <button onclick="backspace()">←</button>
      <button class="ok" onclick="submitKeyboard()">OK</button>
    </div>
  </div>
</div>

</body>

</html>
