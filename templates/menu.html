{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Касса — Меню</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <script defer src="{% static 'js/cart.js' %}"></script>

 <style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: #1e1e1e;
  color: #f0f0f0;
  font-size: 16px;
  width: 1024px;
  height: 768px;
  overflow: hidden;
}
.layout {
  display: flex;
  flex-direction: column;
  height: 100%;
}
.topbar {
  height: 60px;
  background: #222;
  color: white;
  padding: 10px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.content {
  display: flex;
  height: calc(100% - 60px);
}
.left {
  flex: 1;
  padding: 8px;
  display: flex;
  flex-direction: column;
}
.categories {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
}
.cat-btn {
  padding: 10px 14px;
  font-size: 16px;
  background: #444;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.grid {
  flex: 1;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* уменьшено */
  gap: 6px;
  padding-right: 6px; /* чтобы скролл не перекрывал */
}
.item {
  background: #2c2c2c;
  border-radius: 6px;
  padding: 4px;
  text-align: center;
  height: 140px; /* уменьшено */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
}
.item img {
  width: 100%;
  height: 60px; /* уменьшено */
  object-fit: cover;
  border-radius: 4px;
}
.item-name { font-size: 13px; margin-top: 4px; }
.item-price { font-size: 14px; font-weight: bold; color: #ffc107; margin-top: 2px; }

/* Корзина */
.cart-panel {
  width: 300px;
  background: #2a2a2a;
  display: flex;
  flex-direction: column;
  height: 100%;
}
.cart-inner {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px;
  overflow-y: auto;
}
.cart-panel h2 { font-size: 18px; margin-bottom: 6px; }
#cart-items {
  flex: 1;
  overflow-y: auto;
  border: 1px solid #444;
  border-radius: 6px;
  background: #1f1f1f;
  margin-bottom: 8px;
}
#cart-items li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px;
  font-size: 14px;
}
.cart-total { font-size: 16px; margin: 6px 0; }
.cash-box input {
  font-size: 16px;
  padding: 8px;
  border-radius: 4px;
  width: 100%;
}
.cart-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
}
.cart-actions button {
  flex: 1;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
#btn-checkout { background: #28a745; color: white; }
#btn-clear { background: #ff4d4d; color: white; }
.product-scroll {
  flex: 1;
  overflow-y: auto;
  max-height: calc(768px - 60px - 90px); /* высота экрана минус topbar и категории */
}
   .modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none; /* по умолчанию скрыто */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  background: #2c2c2c;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  width: 300px;
  color: white;
}

.modal-content h2 {
  margin-bottom: 12px;
}

.modal-content input {
  width: 90%;
  padding: 10px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
}

.modal-content button {
  margin-top: 12px;
  padding: 10px 16px;
  font-size: 16px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

</style>

</head>

<body>

{% if not employee %}
<div id="pinModal" class="modal" aria-hidden="false">
  <div class="modal-content">
    <h2>Введите PIN кассира</h2>
    <input type="password" id="pinInput" placeholder="PIN" autocomplete="off" />
    <button id="pinSubmit">Войти</button>
    <p id="pinError" style="color:red; display:none; margin-top:8px;">Неверный PIN</p>
  </div>
</div>
{% endif %}

<div class="layout">
  <header class="topbar">
    <div class="brand">Mediar fried chiken</div>
    <div class="employee" id="employeeName">
      Кассир: {{ employee.name|default:"Не выбрано" }}
      {% if employee and employee.role == "админ" %}
        <a href="{% url 'report_by_date' %}" style="margin-left: 20px; font-weight: bold; color: white;">Отчёт</a>
      {% endif %}
      <a href="{% url 'orders_list' %}" style="margin-left: 20px; font-weight: bold; color: white;">Заказы</a>
      <a href="{% url 'logout' %}" style="margin-left: 20px; font-weight: bold; color: #ff4d4d;">Выход</a>
      {% if employee and employee.role == "админ" %}
        <a href="/admin/" style="margin-left: 20px; font-weight: bold; color: #ffc107;">Админка</a>
      {% endif %}
    </div>
  </header>

  <main class="content">
    <section class="left">
      <div class="categories">
        {% for cat in categories %}
          <button class="cat-btn" data-cat="{{ cat }}">{{ cat|title }}</button>
        {% empty %}
          <p>Категории не найдены</p>
        {% endfor %}
      </div>

      <div class="product-scroll">
        <div class="grid" id="product-grid">
          {% for p in products %}
          <div class="item"
               data-category="{{ p.category }}"
               data-id="{{ p.id }}"
               data-name="{{ p.name }}"
               data-price="{{ p.price }}">
            <img src="{% if p.image %}{{ p.image.url }}{% else %}{% static 'images/placeholder.jpg' %}{% endif %}"
                 alt="{{ p.name }}">
            <div class="item-name">{{ p.name }}</div>
            <div class="item-price">{{ p.price }} сом</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </section>

    <aside class="cart-panel">
      <div class="cart-inner">
        <h2>Корзина</h2>
        <ul id="cart-items"></ul>

        <div class="cart-total">Итого: <span id="cart-total">0</span> сом</div>

        <div class="cash-box">
          <label for="cashGiven">Получено от клиента:</label>
          <input type="number" id="cashGiven" placeholder="Введите сумму" />
          <div class="change">Сдача: <span id="changeAmount">0</span> сом</div>
        </div>

        <textarea id="order-note" placeholder="Комментарий к заказу" rows="2"></textarea>

        <div class="cart-actions">
          <button id="btn-checkout">Оформить заказ</button>
          <button id="btn-clear">Очистить</button>
        </div>
      </div>
    </aside>
  </main>
</div>
<div id="notify" class="notify"></div>

<script>
  window.EMPLOYEE_ID = {% if employee and employee.id %}{{ employee.id }}{% else %}null{% endif %};
</script>

<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    var pinModal = document.getElementById('pinModal');
    var pinInput = document.getElementById('pinInput');
    var pinSubmit = document.getElementById('pinSubmit');
    var pinError = document.getElementById('pinError');

    if (!pinModal) return;

    if (pinInput) pinInput.focus();

    function showError(msg) {
      if (pinError) {
        pinError.textContent = msg || 'Неверный PIN';
        pinError.style.display = 'block';
      }
    }
    function hideError() {
      if (pinError) pinError.style.display = 'none';
    }

    async function submitPin() {
      try {
        hideError();
        var pin = (pinInput && pinInput.value || '').trim();
        if (!pin) {
          showError('Введите PIN');
          return;
        }
        var resp = await fetch('/employee/get-id/?pin=' + encodeURIComponent(pin));
        if (!resp.ok) {
          showError('Ошибка подключения (' + resp.status + ')');
          return;
        }
        var data = await resp.json();
        if (data && data.id) {
          // редирект на меню с привязкой кассира
          window.location.href = '/menu/?emp=' + data.id;
        } else {
          showError('Неверный PIN');
        }
      } catch (e) {
        console.error('Ошибка при проверке PIN:', e);
        showError('Неожиданная ошибка');
      }
    }

    if (pinSubmit) pinSubmit.addEventListener('click', submitPin);
    if (pinInput) {
      pinInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') submitPin();
      });
    }
  });
})();
</script>

<script>
(function() {
  function updateChange() {
    const cashInput = document.getElementById('cashGiven');
    const changeSpan = document.getElementById('changeAmount');
    const totalSpan = document.getElementById('cart-total');

    if (!cashInput || !changeSpan || !totalSpan) return;

    // берём только число из total, убираем всё лишнее кроме цифр, точки и минуса
    const totalText = (totalSpan.textContent || '').replace(/[^\d.-]/g, '');
    const total = parseFloat(totalText) || 0;
    const cash = parseFloat(cashInput.value) || 0;
    const change = cash - total;

    // показываем как есть (может быть отрицательным)
    changeSpan.textContent = change.toFixed(2);

    // цветовое оформление
    if (change >= 0) {
      changeSpan.classList.add('positive');
      changeSpan.classList.remove('negative');
    } else {
      changeSpan.classList.add('negative');
      changeSpan.classList.remove('positive');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const cashInput = document.getElementById('cashGiven');
    if (cashInput) {
      cashInput.addEventListener('input', updateChange);
    }

    const cartTotal = document.getElementById('cart-total');
    if (cartTotal) {
      const observer = new MutationObserver(updateChange);
      observer.observe(cartTotal, { childList: true });
    }

    updateChange(); // первый запуск
  });
})();

document.addEventListener('DOMContentLoaded', function() {
  const btnCheckout = document.getElementById('btn-checkout');
  const btnClear = document.getElementById('btn-clear');
  const cashInput = document.getElementById('cashGiven');
  const changeSpan = document.getElementById('changeAmount');
  const cartItems = document.getElementById('cart-items');
  const cartTotal = document.getElementById('cart-total');

  function clearCalculator() {
    if (cashInput) cashInput.value = '';
    if (changeSpan) {
      changeSpan.textContent = '0';
      changeSpan.classList.remove('positive', 'negative');
    }
  }

  function clearCart() {
    if (cartItems) cartItems.innerHTML = '';
    if (cartTotal) cartTotal.textContent = '0';
    clearCalculator();
  }

  if (btnCheckout) {
    btnCheckout.addEventListener('click', function() {
      // здесь твоя логика оформления заказа (отправка на сервер)
      // после успешного оформления очищаем калькулятор и корзину:
      clearCart();
    });
  }

  if (btnClear) {
    btnClear.addEventListener('click', function() {
      clearCart();
    });
  }
});

</script>

</body>
</html>
